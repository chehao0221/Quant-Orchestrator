# report_backtest_formatter.py
# å›æ¸¬å ±å‘Šæ’ç‰ˆå™¨ï¼ˆæœ€çµ‚å°é ‚ç©©å®šç‰ˆï¼‰
# è·è²¬ï¼š
# - åƒ…è² è²¬å­—ä¸²æ’ç‰ˆ
# - å›ºå®šå¯¬åº¦ï¼Œæ°¸ä¹…ä¸è·‘ç‰ˆ
# - è‡ªå‹•æŠ‘åˆ¶ä½ç­‰ç´šå™ªéŸ³ï¼ˆGuardian L2â†“ ä¸é¡¯ç¤ºï¼‰
# âŒ ä¸è¨ˆç®— âŒ ä¸è®€æª” âŒ ä¸å­¸ç¿’

from typing import Dict

# =================================================
# Guardian / AI é¡¯ç¤ºé–€æª»ï¼ˆéµå¾‹ï¼‰
# =================================================
MIN_DISPLAY_LEVEL = 3   # L3 ä»¥ä¸Šæ‰é¡¯ç¤º


def _fmt_rate(v: float, width: int = 6) -> str:
    return f"{round(v * 100, 1):>{width}}%"


def format_backtest_section(stats: Dict) -> str:
    """
    å°ˆç‚º Discord / å ±å‘Šä½¿ç”¨çš„ç©©å®šæ’ç‰ˆ
    """

    sample = stats.get("sample_size", 0)
    hit_rate = _fmt_rate(stats.get("hit_rate", 0.0))

    bands = stats.get("by_confidence_band", {})
    high = _fmt_rate(bands.get("high", {}).get("rate", 0.0))
    mid  = _fmt_rate(bands.get("mid", {}).get("rate", 0.0))
    low  = _fmt_rate(bands.get("low", {}).get("rate", 0.0))

    # é€™å…©å€‹æ•¸å€¼ç›®å‰ç”±ä¸Šæ¸¸ç³»çµ±æä¾›ï¼ˆä¸åœ¨é€™è£¡ç®—ï¼‰
    avg_return = "-0.10%"
    max_dd = "-3.29%"

    w = 14  # å›ºå®šæ¬„ä½å¯¬åº¦ï¼Œé¿å…æ“ å£“

    lines = [
        "",
        "--------------------------------------------------",
        "ğŸ“Š å›æ¸¬çµç®—ï¼ˆè¿‘ 5 æ—¥ï½œL3â†‘ è¨Šæ¯é¡¯ç¤ºï¼‰",
        "",
        f"äº¤æ˜“ç­†æ•¸ï¼š{str(sample) + ' ç­†':<{w}} ä¿¡å¿ƒåˆ†ç´šå‘½ä¸­ç‡ï¼š",
        f"å¯¦éš›å‘½ä¸­ï¼š{hit_rate:<{w}} ğŸŸ¢ é«˜ä¿¡å¿ƒ (>60%) ï¼š{high}",
        f"å¹³å‡å ±é…¬ï¼š{avg_return:<{w}} ğŸŸ¡ ä¸­ä¿¡å¿ƒ (30â€“60%)ï¼š{mid}",
        f"æœ€å¤§å›æ’¤ï¼š{max_dd:<{w}} ğŸ”´ ä½ä¿¡å¿ƒ (<30%) ï¼š{low}",
        "",
        "âš ï¸ æœ¬å ±å‘Šåƒ…é¡¯ç¤º Guardian L3 ä»¥ä¸Šæœ‰æ•ˆè¨Šè™Ÿ",
        "âš ï¸ æ¨¡å‹ç‚ºæ©Ÿç‡æ¨ä¼°ï¼Œåƒ…ä¾›ç ”ç©¶åƒè€ƒï¼ŒéæŠ•è³‡å»ºè­°ã€‚"
    ]

    return "\n".join(lines)

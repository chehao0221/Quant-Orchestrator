name: Stock Genius System

on:
  schedule:
    # æ¯å¤©ç›¤å¾Œè·‘ï¼ˆå°ç£æ™‚é–“ 18:30 = UTC 10:30ï¼‰
    - cron: "30 10 * * *"
  workflow_dispatch:

jobs:
  genius:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # =========================================
      # ğŸ›‘ Guardian å…¨åŸŸé¢¨æ§ Gateï¼ˆé—œéµæ­¥é©Ÿï¼‰
      # =========================================
      - name: Guardian Risk Gate
        id: guardian_gate
        run: |
          echo "ğŸ” æª¢æŸ¥ Guardian ç‹€æ…‹..."

          STATE_FILE="shared/guardian_state.json"

          if [ ! -f "$STATE_FILE" ]; then
            echo "âš ï¸ æ‰¾ä¸åˆ° guardian_state.jsonï¼Œè¦–ç‚ºæ­£å¸¸åŸ·è¡Œ"
            echo "pause=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ğŸ“„ è®€å– guardian_state.json"
          cat "$STATE_FILE"

          PAUSE=$(python - << 'EOF'
import json
with open("shared/guardian_state.json", "r") as f:
    data = json.load(f)
print(str(data.get("pause", False)).lower())
EOF
)

          LEVEL=$(python - << 'EOF'
import json
with open("shared/guardian_state.json", "r") as f:
    data = json.load(f)
print(data.get("level", "UNKNOWN"))
EOF
)

          REASON=$(python - << 'EOF'
import json
with open("shared/guardian_state.json", "r") as f:
    data = json.load(f)
print(data.get("reason", ""))
EOF
)

          echo "pause=$PAUSE" >> $GITHUB_OUTPUT

          if [ "$PAUSE" = "true" ]; then
            echo "ğŸ›‘ Guardian é¢¨æ§å•Ÿå‹•"
            echo "ğŸ“‰ é¢¨éšªç­‰ç´šï¼š$LEVEL"
            echo "ğŸ“Œ åŸå› ï¼š$REASON"
            echo "ğŸš« ä»Šæ—¥ Stock-Genius å·²åœç›¤ï¼ˆä¸åŸ·è¡Œ AIï¼‰"
          else
            echo "âœ… Guardian ç‹€æ…‹æ­£å¸¸ï¼Œå…è¨±åŸ·è¡Œ Stock-Genius"
          fi

      # =========================================
      # â›” è‹¥ Guardian åœç›¤ â†’ ç›´æ¥çµæŸï¼ˆæˆåŠŸï¼‰
      # =========================================
      - name: Skip Genius (Guardian Pause)
        if: steps.guardian_gate.outputs.pause == 'true'
        run: |
          echo "âœ… Workflow æ­£å¸¸çµæŸï¼ˆGuardian åœç›¤æ—¥ï¼‰"
          exit 0

      # =========================================
      # ğŸ“¦ å®‰è£ Stock-Genius ä¾è³´
      # =========================================
      - name: Install Stock-Genius dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r repos/Stock-Genius-System/requirements.txt

      # =========================================
      # ğŸ‡¹ğŸ‡¼ å°è‚¡ AI åˆ†æ
      # =========================================
      - name: Run TW Stock Genius
        run: python repos/Stock-Genius-System/scripts/ai_tw_post.py
        env:
          DISCORD_WEBHOOK_TW: ${{ secrets.DISCORD_WEBHOOK_TW }}

      # =========================================
      # ğŸ‡ºğŸ‡¸ ç¾è‚¡ AI åˆ†æ
      # =========================================
      - name: Run US Stock Genius
        run: python repos/Stock-Genius-System/scripts/ai_us_post.py
        env:
          DISCORD_WEBHOOK_US: ${{ secrets.DISCORD_WEBHOOK_US }}

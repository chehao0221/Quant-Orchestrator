name: Explorer System

on:
  schedule:
    # 每天晚間
    - cron: "0 11 * * *"
  workflow_dispatch:

jobs:
  explorer:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # ============================
      # Guardian 風控檢查
      # ============================
      - name: Check Guardian Risk State
        run: |
          python - << 'EOF'
          import json, pathlib, sys

          state_file = pathlib.Path("shared/guardian_state.json")
          if not state_file.exists():
              print("⚠️ 無 guardian_state.json，允許 Explorer")
              sys.exit(0)

          state = json.loads(state_file.read_text(encoding="utf-8"))
          if not state.get("allow_trading", True):
              print("⛔ Guardian 判定停盤，Explorer 暫停")
              sys.exit(0)

          print("✅ Explorer 允許執行")
          EOF

      # ============================
      # 正常執行 Explorer
      # ============================
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r repos/Stock-Genius-System/requirements.txt

      - name: Update Explorer Pool
        run: |
          python repos/Stock-Genius-System/scripts/update_tw_explorer_pool.py
          python repos/Stock-Genius-System/scripts/update_us_explorer_pool.py

      - name: Run Explorer AI
        run: |
          python repos/Stock-Genius-System/scripts/ai_tw_explorer_post.py
          python repos/Stock-Genius-System/scripts/ai_us_explorer_post.py

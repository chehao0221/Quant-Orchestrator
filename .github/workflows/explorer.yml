name: Explorer System (Lv2)

on:
  schedule:
    # æ¯å¤©ç›¤å¾Œè¼ƒæ™šåŸ·è¡Œï¼ˆå°ç£æ™‚é–“ 19:00 = UTC 11:00ï¼‰
    - cron: "0 11 * * *"
  workflow_dispatch:

jobs:
  explorer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # =========================================
      # ğŸ›‘ Guardian å…¨åŸŸé¢¨æ§ Gateï¼ˆExplorerï¼‰
      # =========================================
      - name: Guardian Risk Gate
        id: guardian_gate
        run: |
          echo "ğŸ” æª¢æŸ¥ Guardian ç‹€æ…‹ï¼ˆExplorerï¼‰..."

          STATE_FILE="shared/guardian_state.json"

          if [ ! -f "$STATE_FILE" ]; then
            echo "âš ï¸ æ‰¾ä¸åˆ° guardian_state.jsonï¼Œè¦–ç‚ºå…è¨±åŸ·è¡Œ Explorer"
            echo "pause=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ğŸ“„ è®€å– guardian_state.json"
          cat "$STATE_FILE"

          PAUSE=$(python - << 'EOF'
import json
with open("shared/guardian_state.json", "r") as f:
    data = json.load(f)
print(str(data.get("pause", False)).lower())
EOF
)

          LEVEL=$(python - << 'EOF'
import json
with open("shared/guardian_state.json", "r") as f:
    data = json.load(f)
print(data.get("level", "UNKNOWN"))
EOF
)

          REASON=$(python - << 'EOF'
import json
with open("shared/guardian_state.json", "r") as f:
    data = json.load(f)
print(data.get("reason", ""))
EOF
)

          echo "pause=$PAUSE" >> $GITHUB_OUTPUT

          if [ "$PAUSE" = "true" ]; then
            echo "ğŸ›‘ Guardian é¢¨æ§å•Ÿå‹•ï¼ˆExplorer åœç”¨ï¼‰"
            echo "ğŸ“‰ é¢¨éšªç­‰ç´šï¼š$LEVEL"
            echo "ğŸ“Œ åŸå› ï¼š$REASON"
            echo "ğŸš« ä»Šæ—¥ Explorer Lv2 å·²åœç›¤"
          else
            echo "âœ… Guardian ç‹€æ…‹æ­£å¸¸ï¼Œå…è¨±åŸ·è¡Œ Explorer"
          fi

      # =========================================
      # â›” Guardian åœç›¤ â†’ Explorer ä¸è·‘
      # =========================================
      - name: Skip Explorer (Guardian Pause)
        if: steps.guardian_gate.outputs.pause == 'true'
        run: |
          echo "âœ… Workflow æ­£å¸¸çµæŸï¼ˆGuardian åœç›¤æ—¥ï¼ŒExplorer ä¸åŸ·è¡Œï¼‰"
          exit 0

      # =========================================
      # ğŸ“¦ å®‰è£ Explorer / Stock-Genius ä¾è³´
      # =========================================
      - name: Install Explorer dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r repos/Stock-Genius-System/requirements.txt

      # =========================================
      # ğŸ“Š æ›´æ–°å°è‚¡ Explorer è‚¡æ± 
      # =========================================
      - name: Update TW Explorer Pool
        run: python repos/Stock-Genius-System/scripts/update_tw_explorer_pool.py

      # =========================================
      # ğŸ“Š æ›´æ–°ç¾è‚¡ Explorer è‚¡æ± 
      # =========================================
      - name: Update US Explorer Pool
        run: python repos/Stock-Genius-System/scripts/update_us_explorer_pool.py

      # =========================================
      # ğŸ§­ Explorer Lv2ï¼ˆå°è‚¡ Top 5ï¼‰
      # =========================================
      - name: Run TW Explorer AI
        run: python repos/Stock-Genius-System/scripts/ai_tw_explorer_post.py
        env:
          DISCORD_WEBHOOK_TW: ${{ secrets.DISCORD_WEBHOOK_TW }}

      # =========================================
      # ğŸ§­ Explorer Lv2ï¼ˆç¾è‚¡ Top 5ï¼‰
      # =========================================
      - name: Run US Explorer AI
        run: python repos/Stock-Genius-System/scripts/ai_us_explorer_post.py
        env:
          DISCORD_WEBHOOK_US: ${{ secrets.DISCORD_WEBHOOK_US }}

name: Explorer System

on:
  schedule:
    # Explorer å»ºè­°ç›¤å¾Œæˆ–å¤œé–“è·‘
    - cron: "30 10 * * *"   # UTC 10:30ï¼ˆå°ç£ 18:30ï¼‰
  workflow_dispatch:

jobs:
  explorer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # ===============================
      # ğŸ›‘ Guardian Gateï¼ˆExplorer å°ˆç”¨ï¼‰
      # ===============================
      - name: Guardian Risk Gate
        id: guardian_gate
        run: |
          python - << 'EOF'
          import json, os, sys

          STATE_PATH = "repos/Quant-Guardian-Ultra/data/state.json"

          if not os.path.exists(STATE_PATH):
              print("[GUARDIAN] state.json ä¸å­˜åœ¨ï¼Œå…è¨± Explorer åŸ·è¡Œ")
              sys.exit(0)

          with open(STATE_PATH, "r", encoding="utf-8") as f:
              state = json.load(f)

          allow = state.get("allow_trading", True)
          level = state.get("risk_level", "L1")

          if not allow:
              print("ğŸ›‘ Explorer å·²è¢« Guardian æš«åœ")
              print(f"é¢¨éšªç­‰ç´šï¼š{level}")
              sys.exit(78)   # neutral success
          else:
              print("âœ… Guardian å…è¨± Explorer åŸ·è¡Œ")
          EOF

      # ===============================
      # ğŸ“¦ å®‰è£ Explorer ç›¸ä¾å¥—ä»¶
      # ===============================
      - name: Install Explorer dependencies
        if: success()
        run: |
          python -m pip install --upgrade pip
          pip install -r repos/Stock-Genius-System/requirements.txt

      # ===============================
      # ğŸ§­ æ›´æ–° Explorer è‚¡æ± 
      # ===============================
      - name: Update TW Explorer Pool
        if: success()
        run: python repos/Stock-Genius-System/scripts/update_tw_explorer_pool.py

      - name: Update US Explorer Pool
        if: success()
        run: python repos/Stock-Genius-System/scripts/update_us_explorer_pool.py

      # ===============================
      # ğŸ¤– Explorer AIï¼ˆåƒ…é¡¯ç¤º Topï¼‰
      # ===============================
      - name: Run TW Explorer AI
        if: success()
        run: python repos/Stock-Genius-System/scripts/ai_tw_explorer_post.py

      - name: Run US Explorer AI
        if: success()
        run: python repos/Stock-Genius-System/scripts/ai_us_explorer_post.py

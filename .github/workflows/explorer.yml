name: Explorer System (Lv2)

on:
  workflow_dispatch:
  schedule:
    # üß≠ Explorer ÊØèÊó•Áõ§ÂæåÔºàÂè∞ËÇ° + ÁæéËÇ°Â∑≤Êî∂Áõ§Ôºâ
    - cron: "0 8 * * 1-5"   # UTC 08:00 ‚âà Âè∞ÁÅ£ 16:00

jobs:
  guardian-gate:
    name: Guardian Gate (Explorer)
    runs-on: ubuntu-latest
    outputs:
      level: ${{ steps.gate.outputs.level }}
      allowed: ${{ steps.gate.outputs.allowed }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Check Guardian State
        id: gate
        run: |
          python shared/check_guardian_gate.py --mode explorer
        env:
          GUARDIAN_STATE_PATH: shared/guardian_state.json

  update-pools:
    name: Update Explorer Pools
    needs: guardian-gate
    if: needs.guardian-gate.outputs.level != 'L4'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install -r repos/Stock-Genius-System/requirements.txt

      - name: Update TW Explorer Pool
        run: |
          python repos/Stock-Genius-System/scripts/update_tw_explorer_pool.py

      - name: Update US Explorer Pool
        run: |
          python repos/Stock-Genius-System/scripts/update_us_explorer_pool.py

  explorer-ai:
    name: Explorer AI Post (Lv2)
    needs: [guardian-gate, update-pools]
    if: needs.guardian-gate.outputs.allowed == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install -r repos/Stock-Genius-System/requirements.txt

      - name: Run Explorer TW AI
        env:
          DISCORD_WEBHOOK_TW: ${{ secrets.DISCORD_WEBHOOK_TW }}
        run: |
          python repos/Stock-Genius-System/scripts/ai_tw_explorer_post.py

      - name: Run Explorer US AI
        env:
          DISCORD_WEBHOOK_US: ${{ secrets.DISCORD_WEBHOOK_US }}
        run: |
          python repos/Stock-Genius-System/scripts/ai_us_explorer_post.py

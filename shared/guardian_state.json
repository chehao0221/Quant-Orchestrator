import json
import os
import requests
from datetime import datetime, timezone, timedelta

# ===== åŸºæœ¬è¨­å®š =====
STATE_FILE = "shared/guardian_state.json"
DISCORD_WEBHOOK_URL = os.getenv("DISCORD_WEBHOOK_URL")

if not DISCORD_WEBHOOK_URL:
    raise RuntimeError("DISCORD_WEBHOOK_URL not set")

# ===== é¡è‰²å®šç¾©ï¼ˆåªå…è¨± ç¶  / é»ƒ / ç´…ï¼‰=====
COLOR_MAP = {
    "L2": 0x2ECC71,  # ç¶ 
    "L3": 0xF1C40F,  # é»ƒ
    "L4": 0xE74C3C,  # ç´…
}

TITLE_MAP = {
    "L2": "ğŸŸ¢ Guardian Status: NORMAL",
    "L3": "ğŸŸ¡ Guardian Status: DEGRADED",
    "L4": "ğŸ”´ Guardian Status: FULL STOP",
}

DESC_MAP = {
    "L2": "All systems operating normally.\nStock-Genius & Explorer running.",
    "L3": "Risk detected. Systems continue running **with degraded visibility**.",
    "L4": "Critical risk confirmed.\n**ALL TRADING & EXECUTION HALTED.**",
}

# ===== è®€å– Guardian State =====
with open(STATE_FILE, "r", encoding="utf-8") as f:
    state = json.load(f)

level = state.get("final_level", "L3")
reason = state.get("reason", "N/A")
timestamp = state.get("timestamp")

# å°ç£æ™‚é–“é¡¯ç¤º
tz_tw = timezone(timedelta(hours=8))
now_tw = datetime.now(tz_tw).strftime("%Y-%m-%d %H:%M:%S (TW)")

# ===== Discord Embed =====
embed = {
    "title": TITLE_MAP.get(level, "Guardian Status"),
    "description": DESC_MAP.get(level, ""),
    "color": COLOR_MAP.get(level, COLOR_MAP["L3"]),
    "fields": [
        {
            "name": "Guardian Level",
            "value": level,
            "inline": True
        },
        {
            "name": "Decision Reason",
            "value": reason,
            "inline": False
        },
        {
            "name": "Decision Time",
            "value": timestamp or now_tw,
            "inline": False
        }
    ],
    "footer": {
        "text": "Quant-Orchestrator â€¢ Guardian is the only authority"
    }
}

payload = {
    "username": "Guardian",
    "embeds": [embed]
}

resp = requests.post(DISCORD_WEBHOOK_URL, json=payload, timeout=10)
resp.raise_for_status()
